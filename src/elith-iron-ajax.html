<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-alert-dialog/paper-alert-dialog.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="elith-constantes.html">

<dom-module id="elith-iron-ajax">
    <template>
        <style include="elith-styles">
        </style>

        <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

        <iron-ajax id="ajax"
               method="[[methode]]"
               content-type="application/json;charset=utf-8"
               handle-as="JSON"
               on-response="handleResponse"
               on-error="handleError">
        </iron-ajax>

        <paper-alert-dialog  modal id="dialogErreur" title="Avertissement" confirm-button="OK">
            Ce dossier client existe déjà, vous allez être redirigé sur la page de la personne.
        </paper-alert-dialog>

        <paper-alert-dialog  modal id="dialog" title="Confirmation" dismiss-button="Annuler" confirm-button="OK"  on-confirm="confirm">
            Êtes-vous sûr de vouloir supprimer ?
        </paper-alert-dialog>


        <paper-icon-button id="[[id]]"
                           focus-target="[[focus]]"
                           hidden="[[isHidden(hidden, link)]]"
                           disabled="[[hidden]]"
                           on-tap="_onAction"
                           icon="elith-icons:[[methode]]">

        </paper-icon-button>


        <template is="dom-if" if="{{link}}">
            <paper-button raised class="primary" on-tap="_onAction">
                [[message]]
            </paper-button>
        </template>



    </template>


    <script>
      class ElithIronAjax extends Polymer.Element {
        static get is () { return 'elith-iron-ajax' }

        static get properties () {
          return {
            storedUser : Object,
            elements : {
              type : Object,
              notify: true,
            },
            element : {
              type: Object,
              notify: true,
            },
            itemid:{
              type: Object,
              notify: true,
            },
            module: String,
            hidden: Object,
            id: {
              type : String,
              observer : '_classChanged',
            },
            methode : String,
            focus: {
              type: Boolean,
              notify: true,
            },
            path : {
              type: Object,
              notify: true,
            },
            erreur:{
              type:Object,
              notify: true,
            },
            // sert à initier les appels lorsqu'il n'y a pas de bouton
            initcall :{
              type : Object,
              notify: true,
              observer : '_initCallAjaxChanged',
            },
            response: {
              type:Object,
              notify: true,
            },
            link:{
              type: Object,
              value:false,
            },
            message: Object,
          }
        }


        _classChanged(e){
            let bouton = Polymer.dom(this.root).querySelectorAll('paper-icon-button');
            bouton[0].classList.add('bubble'+e);
        }

        isHidden(hidden, link){
          let res = false ;
          if (link) return true ;

          if(hidden !== null && typeof(hidden) !== 'undefined' ){
            res = (hidden || !link);
          }

          return res;
        }

        _initCallAjaxChanged(initcall){
          if(initcall !== null && typeof(initcall) !== 'undefined'){
            // soit c'est pour l'authentification (pas encore de storedUser) ou pour forcer un nouvel appel
            if(initcall === "true"){
              this.callAjax();
              this.initcall = null ;
            // soit il y a le storedUser dans le initcall
            } else if(initcall.accessToken != null && typeof(initcall.accessToken) !== 'undefined'){
              this.storedUser = initcall ;
              this.callAjax();
            // soit il y a un id
            }else{
              if(initcall !== 0) this.callAjax(initcall);
            }
          }

        }

        _onAction() {
          switch (this.methode) {
            case 'delete': this._delete(); break;
            case 'post': this._post(); break;
            case 'put' : this._update(); break ;
            default : this._default();
          }
        }

        /**************************************************************************************************************/
        _default(){
          this.codeError = 999;
        }
        /**************************************************************************************************************/
        callAjax (idElement) {
          // pas besoin de vérifier le token dans le cas de l'authentification
          let url = `${Elith.Utils.getModule(this.module)}`;
          if(this.module === 'authentication'){
            this.$.ajax.body = this.element ;
          // validation du token
          }else{

            if (this.storedUser !== null && typeof(this.storedUser) !== 'undefined'){
              this.$.ajax.headers['Authorization'] = 'Bearer ' + this.storedUser.accessToken;

              if(idElement !== null && typeof(idElement) !== 'undefined'){
                url = url.concat(`/${idElement}`);
              }else{
                this.$.ajax.body = this.element;
              }
            }
          }
          this.$.ajax.url = url;
          this.$.ajax.generateRequest();
        }
        /**************************************************************************************************************/
        _post(){
          this.callAjax();
          this.focus = null ;
         }
        /**************************************************************************************************************/
        _update(){
          this.callAjax();
          this.focus = null ;
        }
        /**************************************************************************************************************/
        _delete(){
          this._modal();
        }

        _modal(){
          var body = document.querySelector('body');
          Polymer.dom(body).appendChild(this.$.dialog);
          this.$.dialog.open();
        }

        confirm(){
          if(this.element !== null){
            this.callAjax(this.element.id);
              // si c'est dans un tableau :
              if(this.elements != null){
                let index = this.elements.indexOf(this.element);
                if(index === -1){
                  // on trouve l'index en se fiant à l'id
                  index = this.trouverIndex(this.elements, this.element);
                }

                this.elements.splice(index, 1);
                // POUR QUE ÇA NOTIFIE LE CHANGEMENT
                this.elements = this.elements.slice();
              }else{
                this.path = `${this.module}/deleted` ;
              }
          }
        }

        _modalErreur(){
          var body = document.querySelector('body');
          Polymer.dom(body).appendChild(this.$.dialogErreur);
          this.$.dialogErreur.open();
        }
        /**************************************************************************************************************/

        trouverIndex(elements, element){
          if(element !== null){
            let i;
            for (i = 0; i < elements.length; i++) {
              if(element.id === elements[i].id) return i ;
            }
          }

        }


        /**************************************************************************************************************/
        handleResponse(event) {
          try{
            this.response = JSON.parse(event.detail.response);
            // traitement à part pour l'authentification
            if(this.module === 'authentication'){
              if (this.response.accessToken) {
                this.error = '';
                this.storedUser = {
                  name:        this.element.login,
                  accessToken: this.response.accessToken,
                  loggedin:    true,
                  firstname : this.response.prenomToken,  // prénom de la personne logguée
                };

                this.element = {};
              }
             // pour les autres modules
            }else{
              this.element = this.response.items["0"][this.module];
              this.itemid = this.element.id;
              this.path = `${this.module}/${this.element.id}`;
              this.erreur = this.response.errorResponse.code;

              // todo : code spécifique pour les doublons des dossiers clients, à revoir ultérieurement
              if(this.erreur === 405){
                this._modalErreur();
              }

            }
          }catch (e){
            this.erreur = 999;
          }
          return this.response ;
        }

        handleError (event) {
          try{
            this.response = JSON.parse(event.detail.request.xhr.response);
          }catch (e){
            console.log('erreur', e);
            this.erreur = 999;
          }
          return this.response;
        }
      }

      window.customElements.define(ElithIronAjax.is, ElithIronAjax)
    </script>
</dom-module>
