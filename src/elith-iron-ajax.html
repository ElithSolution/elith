<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-alert-dialog/paper-alert-dialog.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="elith-constantes.html">

<dom-module id="elith-iron-ajax">
    <template>
        <style include="elith-styles">
            :host{
                margin:0 auto;
                witdh: 500px;
            }

        </style>
        <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

        <iron-ajax id="ajax"
               method="[[methode]]"
               content-type="application/json;charset=utf-8"
               handle-as="JSON"
               on-response="handleResponse"
               on-error="handleError">
        </iron-ajax>

        <paper-alert-dialog  modal id="dialog" title="Confirmation" dismiss-button="Annuler" confirm-button="OK"  on-confirm="confirm">
            Êtes-vous sûr de vouloir supprimer ?
        </paper-alert-dialog>

        <template is="dom-if" if="{{!link}}">
            <paper-icon-button id="[[id]]"
                               focus-target="[[focus]]"
                               hidden="[[hidden]]"
                               disabled="[[hidden]]"
                               on-tap="_onAction"
                               icon="elith-icons:[[methode]]">
            </paper-icon-button>
        </template>

        <template is="dom-if" if="{{link}}">
            <a href on-tap="_onAction" >[[message]]</a>
        </template>



    </template>


    <script>
      class ElithIronAjax extends Polymer.Element {
        static get is () { return 'elith-iron-ajax' }

        static get properties () {
          return {
            storedUser : Object,
            elements : {
              type : Object,
              notify: true,
            },
            element : {
              type: Object,
              notify: true,
            },
            module: String,
            hidden: Object,
            methode : String,
            id: String,
            focus: {
              type: Boolean,
              notify: true,
            },
            path : {
              type: Object,
              notify: true,
            },
            erreur:{
              type:Object,
              notify: true,
            },
            // sert à initier les appels lorsqu'il n'y a pas de bouton
            initcall :{
              type : Object,
              notify: true,
              observer : '_initCallAjaxChanged',
            },
            response: {
              type:Object,
              notify: true,
            },
            link:{
              type: Object,
              value:false,
            },
            message: Object,
          }
        }


        _initCallAjaxChanged(initcall){
          if(initcall !== null && typeof(initcall) !== 'undefined'){
            // soit c'est pour l'authentification (pas encore de storedUser) ou pour forcer un nouvel appel
            if(initcall === "true"){
              this.callAjax();
              this.initcall = null ;
            // soit il y a le storedUser dans le initcall
            } else if(initcall.accessToken != null && typeof(initcall.accessToken) !== 'undefined'){
              this.storedUser = initcall ;
              this.callAjax();
            // soit il y a un id
            }else{
              if(initcall !== 0) this.callAjax(initcall);
            }
          }

        }

        _onAction() {
          switch (this.methode) {
            case 'delete': this._delete(); break;
            case 'post': this._post(); break;
            case 'put' : this._update(); break ;
            default : this._default();
          }
        }

        /**************************************************************************************************************/
        _default(){
          this.codeError = 999;
        }
        /**************************************************************************************************************/
        callAjax (idElement) {
          // pas besoin de vérifier le token dans le cas de l'authentification
          let url = `${Elith.Utils.getModule(this.module)}`;
          if(this.module === 'authentication'){
            this.$.ajax.body = this.element ;
          // validation du token
          }else{
            if (this.storedUser !== null && typeof(this.storedUser) !== 'undefined'){
              this.$.ajax.headers['Authorization'] = 'Bearer ' + this.storedUser.accessToken;
              if(idElement !== null && typeof(idElement) !== 'undefined'){
                url = url.concat(`/${idElement}`);
              }else{
                this.$.ajax.body = this.element;
              }
            }
          }
          this.$.ajax.url = url;
          this.$.ajax.generateRequest();
        }
        /**************************************************************************************************************/
        _post(){
          this.callAjax();
        }
        /**************************************************************************************************************/
        _update(){
          this.callAjax();
          this.focus = null ;
        }
        /**************************************************************************************************************/
        _delete(){
          this._modal();
        }

        _modal(){
          var body = document.querySelector('body');
          Polymer.dom(body).appendChild(this.$.dialog);
          this.$.dialog.open();
        }

        confirm(){
          if(this.element !== null){
            this.callAjax(this.element.id);
              // si c'est dans un tableau :
              if(this.elements != null){
                let index = this.elements.indexOf(this.element);
                this.elements.splice(index, 1);
                // POUR QUE ÇA NOTIFIE LE CHANGEMENT
                this.elements = this.elements.slice();
              }else{
                this.path = `${this.module}/deleted` ;
              }
          }
        }
        /**************************************************************************************************************/
        handleResponse(event) {
          try{
            this.response = JSON.parse(event.detail.response);
            // traitement à part pour l'authentification
            if(this.module === 'authentication'){
              if (this.response.accessToken) {
                this.error = '';
                this.storedUser = {
                  name:        this.element.login,
                  accessToken: this.response.accessToken,
                  loggedin:    true,
                };
                this.element = {};
              }
             // pour les autres modules
            }else{
              this.element = this.response.items["0"][this.module];
              this.erreur = this.response.errorResponse.code
            }
          }catch (e){
            this.erreur = 999;
          }
          return this.response ;
        }

        handleError (event) {
          try{
            this.response = JSON.parse(event.detail.request.xhr.response);
            console.log(this.response);
          }catch (e){
            console.log('erreur', e);
            this.erreur = 999;
          }
          return this.response;
        }
      }

      window.customElements.define(ElithIronAjax.is, ElithIronAjax)
    </script>
</dom-module>
