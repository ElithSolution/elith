<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box-light.html">
<link rel="import" href="../../bower_components/paper-search/paper-search-panel.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../styles/elith-styles.html">
<link rel="import" href="../elith-utils.html">
<link rel="import" href="../elith-iron-ajax.html">
<link rel="import" href="../elith-data.html">

<dom-module id="elith-client-searchbynom">
  <template>
    <style include="elith-styles">
      :host {
        display: block;
        padding: 5px;
      }

      vaadin-combo-box-light {
        padding-left: 10px;
        min-width: 340px;
        display: block;
      }

      paper-icon-button[disabled]{
        color: var(--elith-white);
      }

      paper-input{
        --paper-input-container-input-color: var(--elith-white);
        --paper-input-container: { padding: 0;};
        --paper-input-container-underline: { display: none; height: 0;};
        --paper-input-container-underline-focus: { display: none; };
        --paper-input-container-color: #f1f1f1;
      }

    </style>

    <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
    <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>
    <app-location route="{{route}}"></app-location>

    <brum-global-variable key="ListePaiements" value="{{listepaiements}}"></brum-global-variable>
    <brum-global-variable key="ListeTarifs" value="{{listetarifs}}"></brum-global-variable>


    <elith-iron-ajax hidden disabled module="clients" methode="get" initcall="{{initcall}}" element="{{search}}" response="{{resultat}}" ></elith-iron-ajax>


      <!--  TEST DE L'APPEL DU SERVICE POUR LE PAIEMENT OU LE TARIF -->
      <elith-iron-ajax hidden disabled module="paiement" methode="get" initcall="{{initcall}}" response="{{listepaiements}}" ></elith-iron-ajax>
      <elith-iron-ajax hidden disabled module="tarif" methode="get" initcall="{{initcall}}" response="{{listetarifs}}" ></elith-iron-ajax>




      <vaadin-combo-box-light  id="clientSearchNom"
                                   items="{{clients}}"
                                   item-value-path="client.id"
                                   item-label-path="client.nomComplet"
                                   style="display: block; width: 100%;" hidden$="{{telephone}}">

             <paper-input label="Nom de la personne" no-label-float value=[[search]]>

              <template>
                  <style is="custom-style">
                      paper-item:hover {
                          font-weight: bold;
                      }
                  </style>

                  <paper-item>
                    <paper-item-body two-line>
                      <div>[[item.client.prenom]] [[item.client.nom]]</div>
                      <div secondary>[[item.client.dateNaissanceString]]</div>
                    </paper-item-body>
                  </paper-item>
              </template>
              <paper-icon-button slot="suffix" class="clear-button" icon="close"></paper-icon-button>
              <paper-icon-button slot="prefix" icon="elith-icons:search" disabled></paper-icon-button>
            </paper-input>
          </vaadin-combo-box-light>

      <!-- recherche par téléphone -->
      <vaadin-combo-box-light  id="clientSearchTel"
                               items="{{clients}}"
                               item-value-path="client.id"
                               item-label-path="client.telephoneChiffre"
                               style="display: block; width: 100%;" hidden$="{{!telephone}}">
          <paper-input label="Numéro de téléphone" no-label-float value=[[search]]>
              <template>
                  <style is="custom-style">
                      paper-item:hover {
                          font-weight: bold;
                      }
                      paper-item-body div.second {
                          color : var(--elith-primary-color-dark);
                          font-size: 0.9em;

                      }
                      paper-item-body div.second:hover {
                          color : var(--elith-white);
                          font-weight: normal;
                      }


                  </style>

                  <paper-item>
                      <paper-item-body two-line>
                          <div>[[item.client.prenom]] [[item.client.nom]]</div>
                          <div class="second">[[item.client.telephone]]</div>
                      </paper-item-body>
                  </paper-item>
              </template>
              <paper-icon-button slot="suffix" class="clear-button" icon="close"></paper-icon-button>
              <paper-icon-button slot="prefix" icon="elith-icons:search" disabled></paper-icon-button>
          </paper-input>
      </vaadin-combo-box-light>

    <div class="divBouton" hidden$="{{noresult}}">
      [[nbRes]] résultats.
    </div>
  </template>


  <script>
     class ElithClientsearchbynom extends Polymer.Element {
      static get is () {
        return 'elith-client-searchbynom'
      }

      static get properties () {
        return {
          storedUser: {
            type:   Object,
            observer: '_onStoredUserChanged',
          },
          routeData:  Object,
          route:      Object,
          clients:    Object,
          search:     {
            type:     String,
            value:    '',
          },
          nbRes: Number,
          idclient: Number,
          update:{
            type : Boolean,
            notify: true,
            observer: '_updateChanged'
          },
          initcall:{
            type: Object,
          },
          resultat: {
            type: Object,
            notify: true,
            observer: '_resultatChanged',
          },
          erreur:{
            type: Object,
          },
          noresult: Boolean,
          telephone: {
            type : Boolean,
            observer: '_telephoneChanged',
          },
          listepaiements: {
            type: Object,
            notify: true,
          },
          listetarifs: {
            type: Object,
            notify: true,
          },
        }
      }



      _resultatChanged () {
        let hasError ;
        if(this.resultat != null && typeof(this.resultat) !== 'undefined'){
          //this.codeErreur = this.resultat.errorResponse.code;
          this.erreur = this.resultat.code;
          // todo : à généraliser
          if(this.erreur == '401'){
            this.storedUser = null;
          }
          hasError = Elith.Utils.hasError(this.erreur); // todo : n'est pas défini
          if(!hasError){
            this.clients = this.resultat.items;
            this.nbRes = this.resultat.items.length;
          }

        }else{
          this.clients = null ;
        }
      }


      _onStoredUserChanged(){
        if (this.storedUser !== null && typeof(this.storedUser) !== 'undefined') {
          // si initcall n'est pas null, on vérifie si on a déjà fait un appel
          if (this.initcall !== null && typeof(this.initcall) !== 'undefined') {
            // si initcall a déjà la valeur du storedUser, on a déjà fait un appel
            if(this.initcall.name !== this.storedUser.name){
              this.initcall =  this.storedUser;
                          }
          // on fait l'appel après un initcall à null
          }else{
            this.initcall =  this.storedUser;
          }
        // pas de storedUser, on veut pas aller chercher la liste
        }else{
          this.initcall = null ;
        }
      }

      ready(){
        super.ready();
        let comboboxTel = this.$.clientSearchTel ;
        let comboboxNom = this.$.clientSearchNom ;


        comboboxTel.addEventListener('value-changed', () => {
          this.idclient = comboboxTel.value;
          let path = ['/client', this.idclient].join('/') ;
          this.set('route.path', path);
        });

        comboboxNom.addEventListener('value-changed', () => {
          this.idclient = comboboxNom.value;
          let path = ['/client', this.idclient].join('/') ;
          this.set('route.path', path);
        });

      }

       _telephoneChanged(){
         this.$.clientSearchNom.value = ''; // pour vider le champ de recherche
         this.$.clientSearchTel.value = ''; // pour vider le champ de recherche
       }

      _updateChanged() {
        if(this.update){
          this.$.clientSearchNom.value = ''; // pour vider le champ de recherche
          this.$.clientSearchTel.value = ''; // pour vider le champ de recherche
          this.initcall = 'true'; // pour forcer un rafraichissement de la liste des clients
        }
      }
    }


    window.customElements.define(ElithClientsearchbynom.is, ElithClientsearchbynom)
  </script>
</dom-module>
