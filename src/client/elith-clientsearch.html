<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box-light.html">
<link rel="import" href="../../bower_components/paper-search/paper-search-panel.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../styles/elith-styles.html">
<link rel="import" href="../elith-utils.html">

<script src="../../bower_components/json.date-extensions/json.date-extensions.js"></script>
<script>
  // use date parser for all JSON.parse() requests
  // make sure to call before any JSON conversions
  JSON.useDateParser();
</script>
<dom-module id="elith-clientsearch">
  <template>
    <style include="elith-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>

    <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
    <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

    <app-location
            route="{{route}}"
            url-space-regex="^[[rootPath]]">
    </app-location>
    <app-route
            route="{{route}}"
            pattern="[[rootPath]]:param"
            data="{{routeData}}"
    >
    </app-route>


    <iron-ajax
            id="getClientsAjax"
            method="get"
            content-type="application/json"
            handle-as="JSON"
            on-response="handleClientsResponse"
            on-error="handleClientsError">
    </iron-ajax>
    
    <vaadin-combo-box-light  id="clientSearch"
                             items="{{clients}}"
                             item-value-path="client.id"
                             item-label-path="client.prenom"
                             style="display: block; width: 100%;">

      <paper-input label="Nom de la personne" class="input" value=[[search]]>
          <template>
          <style>
            paper-icon-item img {
              border-radius: 50%;
              margin-right: 10px;
            }
          </style>
          <paper-icon-item>
            <paper-item-body two-line>
              <div>[[item.client.prenom]] [[item.client.nom]]</div>
              <div secondary>[[formatDate(item.client.dateNaissance)]]</div>
            </paper-item-body>
          </paper-icon-item>
        </template>
        <paper-icon-button slot="suffix" class="clear-button" icon="close"></paper-icon-button>
      </paper-input>

    </vaadin-combo-box-light>
    <div>
      [[nbRes]] r√©sultats.
    </div>

  </template>

  <script>
    class ElithClientsearch extends Polymer.Element {
      static get is () {
        return 'elith-clientsearch'
      }

      constructor () {
        super();
        this.delayTimer = function () {}
      }

      static get properties () {
        return {
          storedUser: {
            type:   Object,
            notify: true,
          },
          routeData:  Object,
          route:      {
            type:     Object,
            observer: '_routeChanged',
          },
          clients:    {
            type: Object
          },
          error:      String,
          search:     {
            type:     String,
            value:    '',
            observer: 'delayTyping'
          },
          nbRes:      {
            type:   Number,
            notify: true,
            value:  0
          },
          idclient:{
            type: Number,
          }
        }
      }

      _routeChanged(){}

      ready(){
        super.ready();
        let combobox = this.$.clientSearch;
        combobox.addEventListener('value-changed', () => {
          this.idclient = combobox.value;
          let path = ['/client', this.idclient].join('/') ;
          this.set('route.path', path);
        });
      }


/*      _filterChanged (e) {
        // case-sensitive starts-with filtering
        this.items = elements.filter(function(el) {
          return el.indexOf(e.detail.value) === 0;
        });
      }*/

      delayTyping () {
        clearTimeout(this.delayTimer)
        let head = this.$.getClientsAjax
        if (typeof(this.storedUser) !== 'undefined') {
          let token = this.storedUser.accessToken
          let searchField = this.search;
          this.delayTimer = setTimeout(function () {
            loadData(head, token, searchField)
          }, 300)
        }
      }

      handleClientsResponse (event) {
        let response = JSON.parse(event.detail.response)
        this.nbRes = response.items.length
        this.clients = response.items
        this.error = null
      }

      handleClientsError (event) {
        try{
          this.error = JSON.parse(event.detail.request.xhr.response)
        }catch(e){
          console.log(e);
          this.error = e;
        }

        if (this.error.code && this.error.code == 401) {
          this.storedUser = null
        }
      }

      _getItemHref(){
        // By returning null when `itemId` is undefined, the href attribute won't be set and
        // the link will be disabled.
        console.log('redirection');
        console.log('route', this.route);
        let path = ['/client', this.idclient].join('/') ;

        this.set('route.path', path);
        console.log('route', this.route);

        //return item ? ['/client', item.client.id].join('/') : null;
      }

      formatDate(date){
        return Elith.Utils.formatDate(date);
      }
    }

    function loadData (clientAjax, token, searchField) {
      clientAjax.headers['Authorization'] = `Bearer ${token}`
      clientAjax.url = `${Elith.PATH.ELITH_CLIENTS}?search=${searchField}`
      clientAjax.generateRequest()
    }

    window.customElements.define(ElithClientsearch.is, ElithClientsearch)
  </script>
</dom-module>
