<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/paper-search/paper-search-panel.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../styles/elith-styles.html">
<link rel="import" href="../elith-utils.html">

<script src="../../bower_components/json.date-extensions/json.date-extensions.js"></script>
<script>
  // use date parser for all JSON.parse() requests
  // make sure to call before any JSON conversions
  JSON.useDateParser();
</script>
<dom-module id="elith-clientsearch">
  <template>
    <style include="elith-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>

    <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
    <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

    <iron-ajax
            id="getClientsAjax"
            method="get"
            content-type="application/json"
            handle-as="JSON"
            on-response="handleClientsResponse"
            on-error="handleClientsError">
    </iron-ajax>

    <paper-search-panel search="{{search}}"
                        items="[[items]]"
                        has-more="[[hasMore]]"
                        loading="[[loading]]"
                        hide-filter-button=true>

      <div>
        [[nbRes]] r√©sultat(s).
      </div>
    </paper-search-panel>

    <vaadin-grid items="{{clients}}" size="200">
      <vaadin-grid-column width="50px">
        <template>
          <a href$="[[_getItemHref(item)]]"> [[item.client.prenom]]</a>
        </template>
      </vaadin-grid-column>
      <vaadin-grid-column width="50px">
        <template>[[item.client.nom]]</template>
      </vaadin-grid-column>
      <vaadin-grid-column width="50px">
      <template>[[formatDate(item.client.dateNaissance)]]</template>
    </vaadin-grid-column>
    </vaadin-grid>
  </template>

  <script>
    class ElithClientsearch extends Polymer.Element {
      static get is () {
        return 'elith-clientsearch'
      }

      constructor () {
        super()
        this.delayTimer = function () {}
      }

      static get properties () {
        return {
          storedUser: {
            type:   Object,
            notify: true,
          },
          routeData:  Object,
          route:      {
            type:     Object,
            observer: '_routeChanged',
          },
          clients:    {
            type: Object
          },
          error:      String,
          search:     {
            type:     String,
            value:    '',
            observer: 'delayTyping'
          },
          nbRes:      {
            type:   Number,
            notify: true,
            value:  0
          },
        }
      }

      _routeChanged(){}

      delayTyping () {
        clearTimeout(this.delayTimer)
        let head = this.$.getClientsAjax
        if (typeof(this.storedUser) !== 'undefined') {
          let token = this.storedUser.accessToken
          let searchField = this.search
          this.delayTimer = setTimeout(function () {
            loadData(head, token, searchField)
          }, 300)
        }
      }

      handleClientsResponse (event) {
        let response = JSON.parse(event.detail.response)
        this.nbRes = response.items.length
        this.clients = response.items
        this.error = null
      }

      handleClientsError (event) {
        try{
          this.error = JSON.parse(event.detail.request.xhr.response)
        }catch(e){
          console.log(e);
          this.error = e;
        }

        if (this.error.code && this.error.code == 401) {
          this.storedUser = null
        }
      }

      _getItemHref(item){
        // By returning null when `itemId` is undefined, the href attribute won't be set and
        // the link will be disabled.
        return item ? ['/client', item.client.id].join('/') : null;
      }

      formatDate(date){
        return Elith.Utils.formatDate(date);
      }
    }

    function loadData (clientAjax, token, searchField) {
      clientAjax.headers['Authorization'] = `Bearer ${token}`
      clientAjax.url = `${Elith.PATH.ELITH_CLIENTS}?search=${searchField}`
      clientAjax.generateRequest()
    }

    window.customElements.define(ElithClientsearch.is, ElithClientsearch)
  </script>
</dom-module>
