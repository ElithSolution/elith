<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-item.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../styles/elith-styles.html">
<link rel="import" href="../my-icons.html">

<link rel="import" href="elith-client-traitements.html">
<link rel="import" href="elith-client-form.html">

<script src="../../bower_components/json.date-extensions/json.date-extensions.js"></script>
<script>
  JSON.useDateParser()
</script>

<dom-module id="elith-clientdetail">
    <template>
        <style include="elith-styles">
            :host {
                display: block;
                padding: 10px;
            }

            .details {
                padding: 10px;
                margin: 10px;
                justify-content: space-around;
                align-items: center;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14);
                display: block;
            }

            .flex-horizontal-with-ratios {
                @apply --layout-horizontal;
            }

            .flexchild {
                @apply --layout-flex;
            }

            .flex2child {
                @apply --layout-flex-2;
            }
            paper-toggle-button.pink {
                --paper-toggle-button-checked-bar-color:  var(--paper-pink-500);
                --paper-toggle-button-checked-button-color:  var(--paper-pink-500);
                --paper-toggle-button-checked-ink-color: var(--paper-pink-500);
                --paper-toggle-button-unchecked-bar-color:  var(--paper-indigo-900);
                --paper-toggle-button-unchecked-button-color:  var(--paper-indigo-900);
                --paper-toggle-button-unchecked-ink-color: var(--paper-indigo-900);
            }

            .clientNameHeader{
                border-bottom: 2px solid;
                margin-bottom: 40px;
            }
            .clientNameHeader h1{
                display: inline;
            }
            .clientNameHeader paper-icon-button{
                display: inline-flex;
            }
        </style>

        <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

        <iron-ajax
                id="updateClientAjax"
                method="post"
                content-type="application/json"
                handle-as="text/json"
                on-response="handleUpdateResponse"
                on-error="handleUpdateError">
        </iron-ajax>
        <iron-ajax id="deleteByIdAjax"
                   method="delete"
                   content-type="application/json"
                   handle-as="JSON"
                   on-response="handleDeleteResponse"
                   on-error="handleDeleteError">
        </iron-ajax>
        <!------------------------------------------------------------------------------------------------>
        <!------------------------------------------------------------------------------------------------>


                <div class="clientNameHeader"><h1> [[resultat.items.0.client.prenom]]  [[resultat.items.0.client.nom]] </h1>
                <paper-icon-button icon="my-icons:edit" on-tap="activeModeEdition" hidden$="[[modeEdition]]"></paper-icon-button>
                <paper-icon-button icon="my-icons:check-circle" on-tap="postUpdateClient" hidden$="[[!modeEdition]]"></paper-icon-button>
                <paper-icon-button icon="my-icons:delete" on-tap="deleteClient"></paper-icon-button>
                </div>

                <iron-form id="modifClient">
                    <form is="iron-form" id="updateClient" method="post">
                        <elith-client-form client="{{client}}" edition="{{modeEdition}}"></elith-client-form>
                    </form>
                </iron-form>
                <!------------------------------------------------------------------------------------------------>
                <!--------------------        Affichage des traitements de la personne        -------------------->
                <!------------------------------------------------------------------------------------------------>
                <elith-client-traitements traitements="{{traitements}}"></elith-client-traitements>


        <dom-if if="{{isDeleted}}">
            <template>
                <span> Le client a été supprimé !</span>
            </template>

        </dom-if>


    </template>

    <script>
      class ElithClientdetail extends Polymer.Element {
        static get is () {
          return 'elith-clientdetail'
        }

        static get properties () {
          return {
            resultat: {
              type: Object,
              observer: '_resultatChanged',
            },
            client: {
              type: Object,
            },
            traitements:{
              type: Object,
            },
            isDeleted: {
              type: Boolean,
            },
            modeEdition:{
              type: Object,
            },

          }
        }



        _resultatChanged () {
          if(this.resultat != null){
            this.isDeleted = false;
            let item = this.resultat.items;
            if(typeof(item) !== 'undefined'){
              this.client = item["0"].client;
              this.traitements = this.client.traitements;
              this.modeEdition = false;

            }
          }else{
            this.traitements = null ;
          }
        }

        _onActiveItemChanged(e) {
             this.$.grid.expandedItems = [e.detail.value];
             console.log(this.$.grid.expandedItems);
        }

        activeModeEdition () {
          this.modeEdition = true ;
        }

        formatDate(date){
          return Elith.Utils.formatDate(date);
        }

        _setReqBody () {
          //this.$.updateClientAjax.body = this.formData;
        }
        postUpdateClient () {
          // TODO : faire le service updateClient
          console.log(' UPDATE CLIENT');
          //this.$.updateClientAjax.url = Elith.PATH.ELITH_AUTHENTICATE;
          //this._setReqBody();
          //this.$.updateClientAjax.generateRequest();
          this.modeEdition = false;
        }

        deleteClient(){
          console.log('  DELETE CLIENT', this.client.id);
          this.$.deleteByIdAjax.headers['Authorization'] = 'Bearer ' + this.storedUser.accessToken;
          this.$.deleteByIdAjax.url = `${Elith.PATH.ELITH_CLIENT}/${this.client.id}`;
          //this.$.deleteByIdAjax.generateRequest();
          // TODO : rafraichir l'affichage et rappeler le search
          this.isDeleted = true ;
          this.resultat = null ;
        }

        handleDeleteResponse(event) {
          this.handleResponse(event);
        }

        handleResponse(event) {
          console.log('  handleResponse  ');
          var response = JSON.parse(event.detail.response);
          console.log("réponse de la requête ajax : " + response);
        }

        handleDeleteError (event) {
          console.log('en erreur :  handleError ');

        }

      }


      window.customElements.define(ElithClientdetail.is, ElithClientdetail)
    </script>
</dom-module>
