<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">

<link rel="import" href="elith-client-traitements.html">
<link rel="import" href="elith-client-form.html">
<link rel="import" href="../elith-icons.html">
<link rel="import" href="../elith-error.html">
<link rel="import" href="../elith-iron-ajax.html">
<link rel="import" href="../styles/elith-styles.html">



<dom-module id="elith-clientdetail">
    <template>
        <style include="elith-styles">
            :host {
                display: block;
                padding: 20px;
            }

            paper-tabs {
                height: 30px;
            }
            paper-tab {
                --paper-tab-ink: #fff;
                text-transform: uppercase;
            }


        </style>

        <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>
        <app-location route="{{route}}"></app-location>

        <!------------------------------------------------------------------------------------------------>
        <!------------------------------------------------------------------------------------------------>

        <dom-if if="{{!hasError}}">
            <template >
                <div class="container" >
                    <div class="clientNameHeader" >
                        <h1> [[resultat.items.0.client.prenom]]  [[resultat.items.0.client.nom]] </h1>
                    </div>

                    <elith-iron-ajax id="1" hidden$="[[masquerPut]]" element="[[client]]" module="client" methode="put" response="{{resultat}}"></elith-iron-ajax>
                    <paper-icon-button class="bubble1" icon="elith-icons:edit" on-tap="activeModeEdition" hidden$="[[masquerEdit]]"></paper-icon-button>
                    <elith-iron-ajax id="2" element="[[client]]" module="client" methode="delete" path="{{route.path}}" hidden$="[[isTraitement]]"></elith-iron-ajax>


                    <div class="clientSousMenu">
                        <paper-tabs selected="{{selected}}" on-iron-select="_onTabSelected">
                            <template is="dom-repeat" items="{{items}}">
                                <paper-tab name$="{{item.id}}">[[item.name]]</paper-tab>
                            </template>

                        </paper-tabs>
                    </div>

                    <iron-form id="modifClient">
                        <form is="iron-form" id="updateClient" method="post">
                            <elith-client-form section=[[section]] client="{{client}}" edition="{{modeEdition}}" invalide="{{invalide}}" traitements="{{traitements}}"></elith-client-form>
                        </form>
                    </iron-form>
                </div>


            </template>

        </dom-if>
    </template>

    <script>
      class ElithClientdetail extends Polymer.Element {
        static get is () {
          return 'elith-clientdetail'
        }

        static get properties () {
          return {
            route: {
              path: {
                type: Object,
                observer: '_pathChanged',
              }
            },
            resultat: {
              type: Object,
              notify: true,
              observer: '_resultatChanged',
            },
            client: Object,
            traitements: Object,
            modeEdition: {
              type : Object,
              observer: '_onModeEditionChanged',
            },
            hasError: {
              type: Boolean,
              value : false,
            },
            codeErreur : Object,
            invalide: {
              value : false,
            },
            items: {
              type: Array,
              value: function() {
                return [
                  {id: 'RENSEIGNEMENTS', name :'renseignements personnels'},
                  {id: 'INFO', name : 'informations médicales'},
                  {id: 'NOTES', name:'notes du thérapeute'},
                  {id: 'TRAITEMENTS', name: 'traitements'}
                  ];
              }
            },
            section: Object,
            isTraitement: {
              type: Boolean,
              value : false,
            },
            masquerEdit: {
              type: Boolean,
              value : false,
            },
            masquerPut: {
              type: Boolean,
              value : false,
            },

          }
        }


        _onModeEditionChanged(){
          this.masquerEdit = (this.isTraitement || this.modeEdition);
          this.masquerPut = (this.isTraitement || !this.modeEdition);
        }

        _onTabSelected(e) {
          var selectedIndex = e.srcElement.selected;
          var item = this.items[selectedIndex];
          this.section = item.id;
          this.isTraitement = (this.section === 'TRAITEMENTS');
          this.masquerEdit = (this.isTraitement || this.modeEdition);
          this.masquerPut = (this.isTraitement || !this.modeEdition);
        }

        _pathChanged(path){
          if(path !== null && typeof(path) !== 'undefined'){
            this.set('route.path', path);
          }
        }

        _resultatChanged () {
          if(this.resultat != null && typeof(this.resultat) !== 'undefined'){
            this.codeErreur = this.resultat.errorResponse.code;
            this.hasError = Elith.Utils.hasError(this.codeErreur);
            let item = this.resultat.items;
            if(typeof(item) !== 'undefined'){
              this.client = item["0"].client;
              this.traitements = this.client.traitements;
              this.modeEdition = false;
            }
          }else{
            this.traitements = null ;
          }
        }

        activeModeEdition () {
          this.modeEdition = true ;

        }

    }

      window.customElements.define(ElithClientdetail.is, ElithClientdetail)
    </script>
</dom-module>
