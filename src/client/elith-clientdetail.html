<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-item.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../styles/elith-styles.html">
<link rel="import" href="../my-icons.html">

<script src="../../bower_components/json.date-extensions/json.date-extensions.js"></script>
<script>
  // use date parser for all JSON.parse() requests
  // make sure to call before any JSON conversions
  JSON.useDateParser()
</script>

<dom-module id="elith-clientdetail">
    <template>
        <style include="elith-styles">
            :host {
                display: block;
                padding: 10px;
            }

            .details {
                padding: 10px;
                margin: 10px;
                justify-content: space-around;
                align-items: center;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14);
                display: block;
            }

            .flex-horizontal-with-ratios {
                @apply --layout-horizontal;
            }

            .flexchild {
                @apply --layout-flex;
            }

            .flex2child {
                @apply --layout-flex-2;
            }
            paper-toggle-button.pink {
                --paper-toggle-button-checked-bar-color:  var(--paper-pink-500);
                --paper-toggle-button-checked-button-color:  var(--paper-pink-500);
                --paper-toggle-button-checked-ink-color: var(--paper-pink-500);
                --paper-toggle-button-unchecked-bar-color:  var(--paper-indigo-900);
                --paper-toggle-button-unchecked-button-color:  var(--paper-indigo-900);
                --paper-toggle-button-unchecked-ink-color: var(--paper-indigo-900);
            }

            .clientNameHeader{
                border-bottom: 2px solid;
                margin-bottom: 40px;
            }
            .clientNameHeader h1{
                display: inline;
            }
            .clientNameHeader paper-icon-button{
                display: inline-flex;
            }
        </style>

        <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
        <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

        <iron-ajax
                id="updateClientAjax"
                method="post"
                content-type="application/json"
                handle-as="text/json"
                on-response="handleLoginResponse"
                on-error="handleUserError">
        </iron-ajax>

        <dom-if if="{{hasResult}}">
            <template>
                <div class="clientNameHeader"><h1> [[resultat.items.0.client.prenom]]  [[resultat.items.0.client.nom]] </h1>
                <paper-icon-button icon="my-icons:edit" on-tap="activeModeEdition"></paper-icon-button>
                </div>

                <iron-form id="modifClient">
                    <form action="postUpdateClient">
                        <fieldset>
                            <legend>Renseignements personnels</legend>
                            <vaadin-form-layout>
                                <paper-input label="Nom" value="[[resultat.items.0.client.nom]]" readonly$="[[!modeEdition]]"></paper-input>
                                <paper-input label="Prénom" value="[[resultat.items.0.client.prenom]]" readonly$="[[!modeEdition]]"></paper-input>
                                <paper-input label="Naissance" value="[[formatDate(resultat.items.0.client.dateNaissance)]]" readonly$="[[!modeEdition]]"></paper-input>
                                <br>
                                <paper-input label="Adresse" value="[[resultat.items.0.client.adresse]]" readonly$="[[!modeEdition]]"></paper-input>
                                <paper-input label="Ville" value="[[resultat.items.0.client.ville]]" readonly$="[[!modeEdition]]"></paper-input>
                                <br>
                                <paper-input label="Téléphone" value="[[resultat.items.0.client.telephone]]" readonly$="[[!modeEdition]]"></paper-input>
                                <br>
                                <paper-input label="Courriel" value="[[resultat.items.0.client.email]]" readonly$="[[!modeEdition]]"></paper-input>
                                <br>
                                <paper-input label="Enfant(s)" value="[[resultat.items.0.client.enfants]]" readonly$="[[!modeEdition]]"></paper-input>
                                <br>
                                <paper-input label="Emploi" value="[[resultat.items.0.client.emploi]]" readonly$="[[!modeEdition]]"></paper-input>
                                <br>
                                <paper-input label="Loisirs" value="[[resultat.items.0.client.loisirs]]" readonly$="[[!modeEdition]]"></paper-input>
                                <br>

                            </vaadin-form-layout>
                        </fieldset>

                    </form>
                </iron-form>

                <div class="container flex-horizontal-with-ratios">
                <div class="flexchild">
                    <div class="card">
                        <span> Référé par :  [[resultat.items.0.client.refere]] </span><br>
                        <span> Autres thérapies :  [[resultat.items.0.client.autresTherapies]] </span><br>
                        <span> Médicaments :  [[resultat.items.0.client.medicaments]] </span><br>
                        <span> Compléments :  [[resultat.items.0.client.complements]] </span><br>
                        <span> Constipation :  [[resultat.items.0.client.constipation]] </span><br>
                        <span> Allergies :  [[resultat.items.0.client.allergies]] </span><br>
                        <span> Opérations :  [[resultat.items.0.client.operations]] </span><br>
                    </div>
                </div>

            </div>
                <div class="container flex-horizontal-with-ratios">
                    <div class="flex2child">
                        <div class="card">
                            <span> Historique de la douleur :  [[resultat.items.0.client.histoDouleur]] </span><br>
                            <span> Constatations :  [[resultat.items.0.client.constatations]] </span><br>
                            <span> Attention :  [[resultat.items.0.client.attentions]] </span><br>
                            <span> À ne pas masser :  [[resultat.items.0.client.pasMasser]] </span><br>
                            <span> Note :  [[resultat.items.0.client.note]] </span><br>


                        </div>
                    </div>
                    <div class="flexchild">
                        <div class="card">
                            <paper-toggle-button checked="[[resultat.items.0.client.cardiaque]]" class="pink">Cardiaque</paper-toggle-button>
                            <paper-toggle-button checked="[[resultat.items.0.client.asthme]]" class="pink">Asthme</paper-toggle-button>
                            <paper-toggle-button checked="[[resultat.items.0.client.hypoglycemie]]" class="pink">Hypoglycémie</paper-toggle-button>
                            <paper-toggle-button checked="[[resultat.items.0.client.diabete]]" class="pink">Diabète</paper-toggle-button>
                            <paper-toggle-button checked="[[resultat.items.0.client.peau]]" class="pink">Problème de peau</paper-toggle-button>
                            <paper-toggle-button checked="[[resultat.items.0.client.fumeur]]" class="pink">Fumeur</paper-toggle-button>
                            <paper-toggle-button checked="[[resultat.items.0.client.osteoporose]]" class="pink">Ostéporose</paper-toggle-button>
                            <paper-toggle-button checked="[[resultat.items.0.client.arthrose]]" class="pink">Arthrose</paper-toggle-button>

                        </div>

                    </div>
                </div>

            </template>
        </dom-if>
        <!------------------------------------------------------------------------------------------------>
        <!--------------------        Affichage des traitements de la personne        -------------------->
        <!------------------------------------------------------------------------------------------------>
        <iron-icon class="grayIcon" icon="supervisor-account" slot="item-icon"></iron-icon> Traitements
        <vaadin-grid active-item="{{activeItem}}"
                     id="grid"
                     items="[[resultat.items.0.client.traitements]]"
                     size="200"
                     >

            <template class="row-details">
                <div class="details">
                    <span><strong>Traitement </strong>: [[item.traitement]]</span><br>
                    <span>Conseils : [[item.conseils]]</span><br>
                    <span>Commentaires : [[item.commentaires]]</span><br>
                </div>
            </template>
            <vaadin-grid-column width="20%">
                <template class="header">Date visite</template>
                <template>[[formatDate(item.dateVisite)]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
                <template class="header">Raison</template>
                <template>[[item.raison]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
                <template class="header">Thérapeute</template>
                <template>[[item.login]]</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="20%">
                <template class="header">Mode paiement</template>
                <template>[[item.prix]]$ ([[item.modePaiement]])</template>
            </vaadin-grid-column>
            <vaadin-grid-column width="10px">
                <template class="header">Plus</template>
                <template>
                    <paper-checkbox checked="{{detailsOpened}}"></paper-checkbox>
                </template>
            </vaadin-grid-column>
        </vaadin-grid>

    </template>

    <script>
      class ElithClientdetail extends Polymer.Element {
        static get is () {
          return 'elith-clientdetail'
        }

        static get properties () {
          return {
            resultat: {
              type: Object,
              observer: '_resultatChanged',
            },
            hasResult: {
              type: Boolean,
            },
            modeEdition: {
              type: Boolean,
              value: false,
            }

          }
        }

        ready(){
          super.ready();
        }


        _resultatChanged () {
          (this.resultat != null) ? this.hasResult = true : this.hasResult = false;
        }

        _onActiveItemChanged(e) {
             this.$.grid.expandedItems = [e.detail.value];
             console.log(this.$.grid.expandedItems);
        }

        activeModeEdition () {
          console.log('mode édition', this.modeEdition);
          this.modeEdition = true ;
          //this.hasResult = false;
          console.log(this.modeEdition);
        }

        formatDate(date){
          return Elith.Utils.formatDate(date);
        }

        _setReqBody () {
          //this.$.updateClientAjax.body = this.formData;
        }
        postUpdateClient () {
          this.$.updateClientAjax.url = Elith.PATH.ELITH_AUTHENTICATE;
          this._setReqBody();
          this.$.updateClientAjax.generateRequest();
        }


      }


      window.customElements.define(ElithClientdetail.is, ElithClientdetail)
    </script>
</dom-module>
