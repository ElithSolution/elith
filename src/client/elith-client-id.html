<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../styles/elith-styles.html">

<link rel="import" href="elith-clientdetail.html">
<link rel="import" href="../elith-error.html">

<script src="../../bower_components/json.date-extensions/json.date-extensions.js"></script>
<script>
  // use date parser for all JSON.parse() requests
  // make sure to call before any JSON conversions
  JSON.useDateParser()
</script>

<dom-module id="elith-client-id">
  <template>
    <style include="elith-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>
    <iron-localstorage name="user-storage" value="{{storedUser}}" on-iron-localstorage-load="initStoredUser"></iron-localstorage>
    <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

    <iron-ajax id="getClientByIdAjax"
               method="get"
               content-type="application/json"
               handle-as="JSON"
               on-response="handleDetailResponse"
               on-error="handleDetailError">
    </iron-ajax>

    <dom-if if="{{hasError}}">
      <template>
        <elith-error code="{{codeError}}"></elith-error>
      </template>
    </dom-if>

    <dom-if if="{{!hasError}}">
      <template>
        <elith-clientdetail resultat="{{resultat}}"></elith-clientdetail>
      </template>
    </dom-if>




  </template>

  <script>
    class ElithClientid extends Polymer.Element {
      static get is () {
        return 'elith-client-id'
      }

      static get properties () {
        return {
          storedUser: Object,
          resultat:   {
            type:  Object,
          },
          idclient:{
            type: Number,
            observer : '_idclientChanged',
          },
          codeError: Object,
          hasError: {
            type: Boolean,
            value : false,
          },

        }
      }


      initStoredUser(){
        if (typeof(this.storedUser) !== 'undefined' && this.storedUser.loggedin) {
          this.callAjax();
        }
      }

      _idclientChanged(){
        this.initStoredUser();
      }


      callAjax () {
      if (typeof(this.storedUser) !== 'undefined'){
            this.$.getClientByIdAjax.url = `${Elith.PATH.ELITH_CLIENT}/${this.idclient}`;
            this.$.getClientByIdAjax.headers['Authorization'] = 'Bearer ' + this.storedUser.accessToken
            this.$.getClientByIdAjax.generateRequest();

        }
      }

      compareToken () {
        let lastToken = 'Bearer ' + this.storedUser.accessToken;
        let usedToken = this.$.getClientByIdAjax.headers['Authorization'];
        if (lastToken !== usedToken) {
          this.initStoredUser()
        }
      }

      handleDetailResponse (event) {
        let response;
        this.compareToken()
        try{
          response = JSON.parse(event.detail.response);
          this.resultat = response;
          this.codeError = this.resultat.errorResponse.code;
        }catch (e){
          this.codeError = 999;
        }
        this.hasError = Elith.Utils.hasError(this.codeError);
      }

      handleDetailError (event) {
        this.compareToken();
        let response = JSON.parse(event.detail.request.xhr.response);
        this.codeError = response.errorResponse.code;
        this.hasError = Elith.Utils.hasError(this.codeError);


      }
    }

    window.customElements.define(ElithClientid.is, ElithClientid)
  </script>
</dom-module>
