<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="../shared-styles.html">

<script src="../../bower_components/json.date-extensions/json.date-extensions.js"></script>
<script>
  // use date parser for all JSON.parse() requests
  // make sure to call before any JSON conversions
  JSON.useDateParser();
</script>

<dom-module id="elith-clientid">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>
    <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
    <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>
    <app-route
            route="{{route}}"
            pattern="[[rootPath]]:item"
            data="{{routeData}}"
    >
    </app-route>


    <iron-ajax id="getDetailByIdAjax"
               <!--auto-->
               url="http://localhost:8080/Elith/webresources/client/345"+[[routeData.item]]
               method="get"
               content-type="application/json"
               handle-as="JSON"
               on-response="handleDetailResponse"
               on-error="handleDetailError">
    </iron-ajax>

    <div class="card">
      <div class="circle"></div>

      <span>routedata : [[routeData]]</span><br>
      <span>route : [[route.path]]</span><br>
      <span>item : [[routeData.item]]</span><br>

    </div>




  </template>

  <script>
    class ElithClientid extends Polymer.Element {
      static get is() {
        return 'elith-clientid'
      }

      static get properties() {
        return {
          storedUser: Object,
          routeData: Object,
          route: {
            type: Object,
            observer: '_routeChanged',
          },
          resultat: {
            type: Object,
            value: '',
          },

        }
      }
      _routeChanged(){
        console.log('routeChanged ', this.routeData);
      }

      ready() {
        super.ready();
        console.log('ready');
        console.log('routeData ', this.routeData);
      }

      initStoredUser() {
        if (this.storedUser.loggedin) {
          this.callAjax();
        }
      }

      callAjax() {
        console.log('CALL AJAX');
          if (typeof(this.routeData) !== 'undefined') {
            this.$.getDetailByIdAjax.url = "http://localhost:8080/Elith/webresources/client/345" ;
            this.$.getDetailByIdAjax.headers['Authorization'] = 'Bearer ' + this.storedUser.accessToken;
            //this.$.getDetailByIdAjax.generateRequest();
          }
      }

      compareToken() {
        let lastToken = 'Bearer ' + this.storedUser.accessToken;
        let usedToken = this.$.getDetailByIdAjax.headers['Authorization'];

        if (lastToken !== usedToken) {
          console.log('pas meme token');
          this.initStoredUser();
        }
      }
      handleDetailResponse(event) {
        console.log('handleResponse');
        this.compareToken();
        var response = JSON.parse(event.detail.response);
        this.resultat = response;
        this.error = null;
      }

      handleDetailError(event) {
        console.log('en erreur :  handleError ' + this.$.getDetailByIdAjax.url);
        this.compareToken();

        var response = JSON.parse(event.detail.request.xhr.response);
        this.error = response;
        if (this.error.code == 401) {
          console.log('ERREUR 401 ');
          //this.storedUser = null;
        }
        if (this.error.code == 404) {
          console.log('ERREUR 404 ');

        }
        console.log('ERREUR ' + this.error.code);

      }
    }

    window.customElements.define(ElithClientid.is, ElithClientid)
  </script>
</dom-module>
