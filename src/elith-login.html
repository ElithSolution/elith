<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/brum-global-variable/brum-global-variable.html">
<link rel="import" href="styles/elith-styles.html">
<link rel="import" href="elith-iron-ajax.html">
<link rel="import" href="elith-error.html">

<dom-module id="elith-login">
  <template>
    <style include="elith-styles">
      :host{
        margin:0 auto;
        witdh: 500px;
      }
    </style>

    <iron-localstorage name="user-storage" value="{{storedUser}}"></iron-localstorage>
    <brum-global-variable key="userData" value="{{storedUser}}"></brum-global-variable>

      <div class="card">

          <h1>Log In</h1>
          <h2>Veuillez entrer votre login et mot de passe ! </h2>

          <form is="iron-form" id="form" method="post">
            <paper-input label="Login" id="login" type="text" value="{{formData.login}}" required></paper-input>
            <paper-input label="Mot de passe" id="motPasse" type="password" value="{{formData.motPasse}}"></paper-input>

            <div class="wrapper-btns ">
              <iron-a11y-keys id="a11y" target="[[target]]" keys="enter" on-keys-pressed="postLogin">
                <elith-iron-ajax hidden disabled module="authentication" methode="post" initcall="[[initcall]]" element="{{formData}}" response="{{reponse}}" ></elith-iron-ajax>
              </iron-a11y-keys>
              <paper-button raised class="primary">
                <elith-iron-ajax module="authentication" methode="post" link="true" message="Connexion" element="{{formData}}" response="{{reponse}}" ></elith-iron-ajax>
              </paper-button>
            </div>
          </form>

      </div>

     <elith-error code="{{codeErreur}}"></elith-error>


  </template>


  <script>
    class ElithLogin extends Polymer.Element {
      static get is () { return 'elith-login' }

      static get properties () {
        return {
          formData:   {
            type:  Object,
            value: {},
          },
          storedUser: Object,
          target:     {
            type: Object,
          },
          initcall:{
            type: Object,
          },
          reponse:{
            type: Object,
            notify: true,
            observer: '_reponseChanged',
          },
          hasError: {
            type: Boolean,
            value : false,
          },
          codeErreur : Object,
        }
      }

      ready () {
        super.ready()
        this.target = this.$.form;
      }

      _reponseChanged(){
        if(this.reponse != null && typeof(this.reponse) !== 'undefined') {
          if(typeof(this.reponse.accessToken) !== 'undefined'){
            this.codeErreur = 200 ;
          }else{
            this.codeErreur = this.reponse.code;
            this.formData = {};
          }
          this.hasError = Elith.Utils.hasError(this.codeErreur);
          this.initcall = null ;

        }
      }

      postLogin(){
        this.initcall = "true";
      }

    }

    window.customElements.define(ElithLogin.is, ElithLogin)
  </script>
</dom-module>
